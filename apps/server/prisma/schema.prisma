// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ORGANIZATION & USERS
// ============================================================================

model Organization {
  id                   String   @id @default(uuid())
  name                 String
  email                String   @unique
  phone                String?
  website              String?

  // Subscription
  subscription_tier    String   @default("free") // free, starter, pro, enterprise
  subscription_status  String   @default("active") // active, trial, cancelled
  trial_ends_at        DateTime?

  // Relations
  users                User[]
  bookings             Booking[]
  conversations        Conversation[]
  subscriptions        Subscription[]

  // Metadata
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@map("organizations")
}

model User {
  id                   String   @id @default(uuid())
  organization_id      String
  organization         Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  // Identity
  email                String   @unique
  first_name           String
  last_name            String
  phone                String?

  // Authentication
  password_hash        String
  role                 String   @default("staff") // admin, manager, staff

  // Status
  active               Boolean  @default(true)
  last_login           DateTime?

  // Relations
  messages             Message[]

  // Metadata
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@map("users")
}

// ============================================================================
// GUESTS & BOOKINGS
// ============================================================================

model Guest {
  id              String       @id @default(cuid())
  email           String?      @unique
  phone           String?
  firstName       String
  lastName        String
  language        String       @default("fr")
  authProvider    AuthProvider
  passwordHash    String?
  refreshToken    String?
  legalAcceptedAt DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Guest Portal relations
  reservations        Reservation[]
  guestMessages       GuestMessage[]
  ratings             Rating[]
  orders              Order[]
  travelJournalEntries TravelJournalEntry[]

  // Legacy relations (Booking, Conversation ‚Äî unused but kept for schema integrity)
  bookings        Booking[]
  conversations   Conversation[]

  @@index([email])
}

model Booking {
  id                   String   @id @default(uuid())
  organization_id      String
  organization         Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  guest_id             String
  guest                Guest    @relation(fields: [guest_id], references: [id], onDelete: Cascade)

  // Booking Details
  confirmation_code    String   @unique
  check_in             DateTime
  check_out            DateTime
  room_number          String?
  room_type            String?

  // Status
  status               String   @default("confirmed") // confirmed, checked_in, checked_out, cancelled

  // Pricing
  total_amount         Float
  currency             String   @default("EUR")

  // Metadata
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@map("bookings")
}

// ============================================================================
// CHAT & CONVERSATIONS
// ============================================================================

model Conversation {
  id                   String   @id @default(uuid())
  organization_id      String
  organization         Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  guest_id             String?
  guest                Guest?   @relation(fields: [guest_id], references: [id], onDelete: SetNull)

  // Conversation Details
  channel              String   @default("web") // web, whatsapp, messenger, instagram
  language             String   @default("fr")

  // Status
  status               String   @default("active") // active, resolved, escalated
  assigned_to          String?  // User ID if escalated

  // AI Insights
  soncas_profile       String?  // securite, orgueil, nouveaute, confort, argent, sympathie
  emotional_state      String?  // positive, neutral, negative, frustrated
  needs_intervention   Boolean  @default(false)
  intervention_reason  String?

  // Relations
  messages             Message[]

  // Metadata
  started_at           DateTime @default(now())
  ended_at             DateTime?
  updated_at           DateTime @updatedAt

  @@map("conversations")
}

model Message {
  id                   String   @id @default(uuid())
  conversation_id      String
  conversation         Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  // Message Details
  role                 String   // user, assistant, system
  content              String   @db.Text

  // AI Metadata
  llm_model            String?  // gpt-4, claude-3, etc.
  tokens_used          Int?
  processing_time_ms   Int?

  // FATE Detection
  objection_detected   Boolean  @default(false)
  objection_type       String?  // too_expensive, complex_integration, etc.
  objection_confidence Float?

  // Emotional Analysis
  sentiment            String?  // positive, neutral, negative
  sentiment_score      Float?   // -1.0 to 1.0
  emotions_detected    Json?    // Array of emotions

  // SONCAS Profile
  soncas_indicators    Json?    // Detected SONCAS indicators

  // User Attribution
  user_id              String?
  user                 User?    @relation(fields: [user_id], references: [id], onDelete: SetNull)

  // Metadata
  created_at           DateTime @default(now())

  @@map("messages")
}

// ============================================================================
// HOUSEKEEPING
// ============================================================================

model HousekeepingCompany {
  id                   String   @id @default(uuid())
  name                 String
  contact_email        String
  contact_phone        String
  active               Boolean  @default(true)

  // Progression soci√©t√©
  progression          HousekeepingCompanyProgression?
  housekeepers         Housekeeper[]

  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@map("housekeeping_companies")
}

model HousekeepingCompanyProgression {
  id                          String   @id @default(uuid())
  company_id                  String   @unique
  company                     HousekeepingCompany @relation(fields: [company_id], references: [id], onDelete: Cascade)

  // Progression globale
  overall_percentage          Float    @default(0)   // 0-100%
  current_level               Int      @default(1)   // 1-5

  // Sources de points
  quality_standards_points    Int      @default(0)   // 40%
  validated_photos_points     Int      @default(0)   // 30%
  satisfaction_points         Int      @default(0)   // 20%
  training_points             Int      @default(0)   // 10%

  // M√©triques
  total_quality_checks        Int      @default(0)
  passed_quality_checks       Int      @default(0)
  photos_submitted            Int      @default(0)
  photos_validated            Int      @default(0)
  avg_satisfaction_score      Float    @default(0)

  // Gating LLM
  autonomous_deployment       Boolean  @default(false)  // >= 70%
  priority_access             Boolean  @default(false)  // >= 80%

  updated_at                  DateTime @updatedAt

  @@map("housekeeping_company_progressions")
}

model Housekeeper {
  id                   String   @id @default(uuid())
  company_id           String
  company              HousekeepingCompany @relation(fields: [company_id], references: [id], onDelete: Cascade)

  // Identit√©
  first_name           String
  last_name            String
  email                String
  phone                String
  registered_phone_id  String?  // Unique device ID for security validation

  // Langues
  native_language      String   // 'ar', 'es', 'pt', 'pl', etc.
  target_language      String   @default("fr")
  current_level        String   @default("A1.1") // A1.1 ‚Üí C2

  // Avatar & Gamification
  avatar_id            String?
  avatar_customization Json?
  total_xp             Int      @default(0)
  level                Int      @default(1)
  badges               Json?    // Array of badge IDs

  // Language Progress
  language_progress         LanguageProgress?
  universal_quiz_responses  UniversalQuizResponse[]

  // Field Work (Agent de Terrain)
  missions                  Mission[]
  security_alerts           SecurityAlert[]

  // Status
  active               Boolean  @default(true)

  // Metadata
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@unique([company_id, email])
  @@map("housekeepers")
}

model LanguageProgress {
  id                   String   @id @default(uuid())
  housekeeper_id       String   @unique
  housekeeper          Housekeeper @relation(fields: [housekeeper_id], references: [id], onDelete: Cascade)

  // Progression
  current_level        String   @default("A1.1")
  total_lessons        Int      @default(0)
  completed_lessons    Int      @default(0)
  total_quizzes        Int      @default(0)
  passed_quizzes       Int      @default(0)

  // Scores
  listening_score      Int      @default(0)
  speaking_score       Int      @default(0)
  reading_score        Int      @default(0)
  writing_score        Int      @default(0)

  // Streak
  current_streak       Int      @default(0)
  longest_streak       Int      @default(0)
  last_activity        DateTime?

  // Certification
  certified_level      String?
  certification_date   DateTime?

  // Relations
  quiz_responses       LanguageQuizResponse[]
  cleaning_responses   CleaningQuizResponse[]

  updated_at           DateTime @updatedAt

  @@map("language_progress")
}

// ============================================================================
// QUIZ SYSTEM - Language Learning
// ============================================================================

model LanguageQuizQuestion {
  id                   String   @id @default(uuid())

  // Question Details
  level                String   // A1.1, A1.2, A2.1, A2.2, B1.1, B1.2, B2.1, B2.2, C1, C2
  category             String   // grammar, vocabulary, listening, speaking, reading
  subcategory          String?  // present_tense, pronouns, hotel_vocabulary, etc.

  // Content
  question_text        String   @db.Text
  question_audio_url   String?  // ElevenLabs audio URL

  // Options (Multiple Choice)
  option_a             String
  option_b             String
  option_c             String
  option_d             String
  correct_option       String   // 'a', 'b', 'c', 'd'

  // Explanation
  explanation_text     String   @db.Text
  explanation_audio    String?  // ElevenLabs audio for explanation

  // Metadata
  difficulty           Int      @default(1) // 1-5
  xp_reward            Int      @default(10)
  tags                 String[] // Array of tags

  // Stats
  times_shown          Int      @default(0)
  times_correct        Int      @default(0)
  success_rate         Float?   // Calculated: times_correct / times_shown

  // Status
  active               Boolean  @default(true)
  validated_by         String?  // Admin who validated

  // Relations
  responses            LanguageQuizResponse[]

  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@index([level])
  @@index([category])
  @@index([difficulty])
  @@map("language_quiz_questions")
}

model LanguageQuizResponse {
  id                   String   @id @default(uuid())

  // Relations
  housekeeper_id       String
  housekeeper          LanguageProgress @relation(fields: [housekeeper_id], references: [id], onDelete: Cascade)

  question_id          String
  question             LanguageQuizQuestion @relation(fields: [question_id], references: [id], onDelete: Cascade)

  // Response Details
  selected_option      String   // 'a', 'b', 'c', 'd'
  is_correct           Boolean
  time_taken_seconds   Int?     // Time to answer

  // Context
  session_id           String?  // Quiz session identifier
  attempt_number       Int      @default(1) // 1st, 2nd, 3rd attempt at this question

  // Rewards
  xp_earned            Int      @default(0)
  badge_unlocked       String?  // Badge ID if unlocked with this answer

  created_at           DateTime @default(now())

  @@index([housekeeper_id])
  @@index([question_id])
  @@index([session_id])
  @@map("language_quiz_responses")
}

// ============================================================================
// QUIZ SYSTEM - Housekeeping/Cleaning Knowledge
// ============================================================================

model CleaningQuizQuestion {
  id                   String   @id @default(uuid())

  // Question Details
  category             String   // products, techniques, safety, standards, time_management
  subcategory          String?  // bathroom_cleaning, bed_making, floor_care, etc.

  // Content
  question_text        String   @db.Text
  question_image_url   String?  // Photo reference (before/after, product labels, etc.)

  // Options (Multiple Choice)
  option_a             String
  option_b             String
  option_c             String
  option_d             String
  correct_option       String   // 'a', 'b', 'c', 'd'

  // Explanation
  explanation_text     String   @db.Text
  explanation_video    String?  // Tutorial video URL

  // Metadata
  difficulty           Int      @default(1) // 1-5
  xp_reward            Int      @default(15)
  tags                 String[] // Array of tags

  // Professional Context
  required_for_cert    Boolean  @default(false) // Required for certification
  hotel_standard       String?  // 3-star, 4-star, 5-star, luxury

  // Stats
  times_shown          Int      @default(0)
  times_correct        Int      @default(0)
  success_rate         Float?

  // Status
  active               Boolean  @default(true)
  validated_by         String?

  // Relations
  responses            CleaningQuizResponse[]

  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@index([category])
  @@index([difficulty])
  @@index([required_for_cert])
  @@map("cleaning_quiz_questions")
}

model CleaningQuizResponse {
  id                   String   @id @default(uuid())

  // Relations
  housekeeper_id       String
  housekeeper          LanguageProgress @relation(fields: [housekeeper_id], references: [id], onDelete: Cascade)

  question_id          String
  question             CleaningQuizQuestion @relation(fields: [question_id], references: [id], onDelete: Cascade)

  // Response Details
  selected_option      String   // 'a', 'b', 'c', 'd'
  is_correct           Boolean
  time_taken_seconds   Int?

  // Context
  session_id           String?
  attempt_number       Int      @default(1)

  // Rewards
  xp_earned            Int      @default(0)
  badge_unlocked       String?

  created_at           DateTime @default(now())

  @@index([housekeeper_id])
  @@index([question_id])
  @@index([session_id])
  @@map("cleaning_quiz_responses")
}

// ============================================================================
// GAMIFICATION - Marketplace & Trading
// ============================================================================

model Item {
  id                   String   @id @default(uuid())

  // Item Details
  type                 String   // avatar, accessory, badge, background, emote
  name                 String
  description          String   @db.Text

  // Visual
  image_url            String   // Asset URL
  thumbnail_url        String?
  model_3d_url         String?  // For 3D avatars/accessories (Three.js)

  // Rarity & Value
  rarity               String   // common, rare, epic, legendary, mythic
  base_price           Int      // XP cost
  current_market_value Int?     // Average trading price

  // Availability
  available_for_purchase Boolean @default(true)
  required_level       Int      @default(1)
  required_badge       String?  // Unlock condition
  limited_edition      Boolean  @default(false)
  max_supply           Int?     // For limited items
  current_supply       Int?

  // Stats & Metadata
  times_purchased      Int      @default(0)
  times_traded         Int      @default(0)
  popularity_score     Float    @default(0)

  // Animation/Special Effects
  animation_data       Json?    // Three.js animation parameters
  special_effects      String[] // Array of effect IDs

  // Status
  active               Boolean  @default(true)

  // Relations
  trades_as_item1      Trade[]  @relation("Item1Trades")
  trades_as_item2      Trade[]  @relation("Item2Trades")

  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@index([type])
  @@index([rarity])
  @@index([available_for_purchase])
  @@map("items")
}

model Trade {
  id                   String   @id @default(uuid())

  // Trading Parties
  seller_id            String   // Housekeeper ID
  buyer_id             String   // Housekeeper ID

  // Items Traded
  item1_id             String?  // Item offered by seller
  item1                Item?    @relation("Item1Trades", fields: [item1_id], references: [id])
  item1_quantity       Int      @default(1)

  item2_id             String?  // Item offered by buyer
  item2                Item?    @relation("Item2Trades", fields: [item2_id], references: [id])
  item2_quantity       Int      @default(1)

  // XP Exchange
  xp_from_seller       Int      @default(0) // XP offered by seller
  xp_from_buyer        Int      @default(0) // XP offered by buyer

  // Trade Status
  status               String   @default("pending") // pending, accepted, rejected, completed, cancelled

  // Negotiation
  offer_message        String?  @db.Text
  counter_offer        String?  @db.Text

  // Completion
  completed_at         DateTime?
  cancelled_reason     String?

  // Fraud Prevention
  flagged              Boolean  @default(false)
  flagged_reason       String?
  admin_reviewed       Boolean  @default(false)

  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@index([seller_id])
  @@index([buyer_id])
  @@index([status])
  @@map("trades")
}

// ============================================================================
// KNOWLEDGE BASE (Dual System)
// ============================================================================

model KnowledgeBaseEntry {
  id                   String   @id @default(uuid())
  organization_id      String?

  // Property relation (for guest portal AI chat)
  propertyId           String?
  property             Property? @relation(fields: [propertyId], references: [id])

  // Content (legacy Q&A format)
  type                 String   // global, property_specific
  category             String   // faq, policy, amenity, local_info, general
  question             String   @db.Text
  answer               String   @db.Text

  // Guest AI Chat fields (title/content format)
  title                String?
  emoji                String   @default("üìñ")
  description          String?
  content              String?  @db.Text
  keywords             String[]
  photos               String[]
  steps                String[]
  status               String   @default("published") // published, draft, archived
  views                Int      @default(0)
  autoResolved         Int      @default(0)
  pinned               Boolean  @default(false)

  // Multilingual
  language             String   @default("fr")
  translations         Json?    // Map of lang -> {question, answer}

  // Metadata
  tags                 String[] // Array of tags
  priority             Int      @default(0)
  active               Boolean  @default(true)

  // Usage Stats
  usage_count          Int      @default(0)
  last_used            DateTime?

  // Timestamps
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@index([organization_id])
  @@index([propertyId, status])
  @@index([propertyId, category])
  @@index([category])
  @@index([language])
  @@map("knowledge_base_entries")
}

// ============================================================================
// ANALYTICS & METRICS
// ============================================================================

model ConversationMetrics {
  id                   String   @id @default(uuid())
  conversation_id      String   @unique
  organization_id      String

  // Performance
  total_messages       Int      @default(0)
  avg_response_time_ms Int      @default(0)
  resolution_time_ms   Int?

  // AI Metrics
  objections_detected  Int      @default(0)
  objections_resolved  Int      @default(0)
  sentiment_changes    Int      @default(0)

  // Outcome
  resolved_by_ai       Boolean  @default(false)
  escalated_to_human   Boolean  @default(false)
  guest_satisfaction   Float?   // 1-5 stars

  // Timestamps
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@index([organization_id])
  @@map("conversation_metrics")
}

// ============================================================================
// HERO QUEST JOURNEY SYSTEM
// ============================================================================

model QuestWorld {
  id                   String   @id @default(uuid())

  // World Details
  world_number         Int      @unique // 1-5
  name                 String   // "L'Arriv√©e dans les T√©n√®bres"
  name_short           String   // "Les T√©n√®bres"
  description          String   @db.Text
  narrative_intro      String   @db.Text // Story introduction
  narrative_outro      String   @db.Text // Story completion

  // Visual & Audio
  theme_color          String   // Hex color for UI theming
  background_image     String?  // World map background
  ambient_music_url    String?  // Howler.js background music
  icon_emoji           String   @default("üåç")

  // Level Requirements
  min_level            String   // "A1.1", "A2.1", etc.
  max_level            String   // "A2.2", "B1.1", etc.
  required_world       Int?     // Previous world that must be completed (null for world 1)
  required_quests      Int      @default(0) // Number of quests from previous world needed

  // Progression
  total_quests         Int      @default(0) // Calculated: main + side quests
  has_boss             Boolean  @default(true)

  // Metadata
  active               Boolean  @default(true)
  display_order        Int      @unique
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  // Relations
  quests               Quest[]
  boss_battle          BossBattle?
  world_progress       WorldProgress[]

  @@index([world_number])
  @@index([display_order])
  @@map("quest_worlds")
}

model Quest {
  id                   String   @id @default(uuid())
  world_id             String
  world                QuestWorld @relation(fields: [world_id], references: [id], onDelete: Cascade)

  // Quest Details
  quest_number         Int      // Order within world
  type                 String   // "main", "side", "boss", "heritage"
  title                String
  description          String   @db.Text
  narrative_text       String   @db.Text // Story context

  // Objectives
  objectives           Json     // Array: [{ id, text, type, target, completed }]
  // Example: [
  //   { id: "obj1", text: "Complete 3 vocabulary exercises", type: "quiz", target: 3, quiz_category: "vocabulary" },
  //   { id: "obj2", text: "Practice airport dialogue", type: "dialogue", target: 1, dialogue_id: "airport_arrival" }
  // ]

  // Requirements
  min_level_cecrl      String   // "A1.1"
  required_quests      String[] // Array of quest IDs that must be completed first

  // Rewards
  xp_base              Int      @default(100)
  xp_bonus             Int      @default(0) // Bonus for 100% completion
  badge_reward         String?  // Badge ID to unlock
  item_rewards         String[] // Item IDs unlocked

  // Visual & Interactive
  quest_icon           String   @default("üìú")
  cover_image          String?
  intro_cutscene       Json?    // Framer Motion animation data
  outro_cutscene       Json?

  // NPCs and Dialogue
  npcs                 Json?    // [{ id, name, avatar, role }]
  dialogue_tree        Json?    // Dialogue system data structure

  // Gameplay Settings
  allow_replay         Boolean  @default(true)
  time_limit_minutes   Int?     // Optional time challenge
  difficulty_modifier  Float    @default(1.0) // XP multiplier

  // Stats
  times_started        Int      @default(0)
  times_completed      Int      @default(0)
  avg_completion_time  Int?     // In minutes
  completion_rate      Float?   // Percentage

  // Status
  active               Boolean  @default(true)
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  // Relations
  quest_progress       QuestProgress[]

  @@unique([world_id, quest_number])
  @@index([world_id])
  @@index([type])
  @@map("quests")
}

model QuestProgress {
  id                   String   @id @default(uuid())

  // Relations
  housekeeper_id       String
  quest_id             String
  quest                Quest    @relation(fields: [quest_id], references: [id], onDelete: Cascade)

  // Progress
  status               String   @default("locked") // locked, available, in_progress, completed, failed
  objectives_state     Json     // Current state of objectives (same structure as Quest.objectives with progress)
  completion_percent   Int      @default(0) // 0-100

  // Session Tracking
  started_at           DateTime?
  completed_at         DateTime?
  total_time_minutes   Int      @default(0)
  attempts             Int      @default(0)

  // Rewards Claimed
  xp_earned            Int      @default(0)
  badges_unlocked      String[] // Badge IDs unlocked from this quest
  items_unlocked       String[] // Item IDs unlocked

  // Performance
  perfect_completion   Boolean  @default(false) // All objectives 100%
  speed_bonus_claimed  Boolean  @default(false)

  // Metadata
  last_played          DateTime?
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@unique([housekeeper_id, quest_id])
  @@index([housekeeper_id])
  @@index([quest_id])
  @@index([status])
  @@map("quest_progress")
}

model WorldProgress {
  id                   String   @id @default(uuid())

  // Relations
  housekeeper_id       String
  world_id             String
  world                QuestWorld @relation(fields: [world_id], references: [id], onDelete: Cascade)

  // Progress
  status               String   @default("locked") // locked, unlocked, in_progress, completed
  quests_completed     Int      @default(0)
  quests_total         Int      @default(0)
  completion_percent   Int      @default(0)

  // Boss Battle
  boss_unlocked        Boolean  @default(false)
  boss_defeated        Boolean  @default(false)
  boss_attempts        Int      @default(0)

  // Timestamps
  unlocked_at          DateTime?
  started_at           DateTime?
  completed_at         DateTime?

  // Stats
  total_xp_earned      Int      @default(0)
  total_time_minutes   Int      @default(0)

  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@unique([housekeeper_id, world_id])
  @@index([housekeeper_id])
  @@index([world_id])
  @@index([status])
  @@map("world_progress")
}

model BossBattle {
  id                   String   @id @default(uuid())
  world_id             String   @unique
  world                QuestWorld @relation(fields: [world_id], references: [id], onDelete: Cascade)

  // Boss Details
  boss_name            String   // "Le Bureaucrate"
  boss_title           String   // "Gardien des T√©n√®bres"
  description          String   @db.Text
  narrative_intro      String   @db.Text
  narrative_victory    String   @db.Text
  narrative_defeat     String   @db.Text

  // Visual
  boss_avatar          String   // Image URL or emoji
  boss_model_3d        String?  // Three.js model (optional)
  arena_background     String?  // Battle background image
  battle_music_url     String?  // Howler.js battle theme

  // Challenge Structure
  challenge_type       String   @default("quiz_gauntlet") // quiz_gauntlet, dialogue_challenge, timed_trial, mixed
  challenge_data       Json     // Specific challenge configuration
  // Example for quiz_gauntlet: { rounds: 3, questions_per_round: 5, passing_score: 80, lives: 3 }

  // Difficulty
  difficulty_level     Int      @default(5) // 1-10 scale
  min_cecrl_level      String   // "A2.2"
  time_limit_minutes   Int?     // Optional time pressure

  // Rewards
  xp_reward            Int      @default(2500)
  badge_reward         String   // Badge unlocked on victory
  item_rewards         String[] // Special items
  unlock_next_world    Boolean  @default(true)

  // Mechanics
  has_phases           Boolean  @default(false)
  phases_data          Json?    // Multi-phase boss battle
  special_mechanics    Json?    // Unique battle mechanics

  // Stats
  times_attempted      Int      @default(0)
  times_defeated       Int      @default(0)
  avg_attempts         Float?   // Average attempts before victory
  defeat_rate          Float?   // Percentage

  // Status
  active               Boolean  @default(true)
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  // Relations
  battle_attempts      BossBattleAttempt[]

  @@index([world_id])
  @@map("boss_battles")
}

model BossBattleAttempt {
  id                   String   @id @default(uuid())

  // Relations
  housekeeper_id       String
  boss_battle_id       String
  boss_battle          BossBattle @relation(fields: [boss_battle_id], references: [id], onDelete: Cascade)

  // Attempt Details
  attempt_number       Int      @default(1)
  status               String   @default("in_progress") // in_progress, victory, defeat, abandoned

  // Performance
  score                Int      @default(0)
  accuracy_percent     Float?
  time_taken_minutes   Int?
  lives_remaining      Int?

  // Challenge Tracking
  rounds_completed     Int      @default(0)
  current_round_data   Json?    // Current state of the battle
  answers_log          Json?    // Log of all answers/actions

  // Result
  victory              Boolean  @default(false)
  xp_earned            Int      @default(0)
  badges_unlocked      String[]

  // Timestamps
  started_at           DateTime @default(now())
  completed_at         DateTime?

  @@index([housekeeper_id])
  @@index([boss_battle_id])
  @@index([status])
  @@map("boss_battle_attempts")
}

model QuestDialogue {
  id                   String   @id @default(uuid())

  // Dialogue Details
  dialogue_id          String   @unique // "airport_arrival"
  title                String
  description          String   @db.Text

  // Structure
  dialogue_tree        Json     // Full branching dialogue structure
  // Example: {
  //   "start": { text: "Bonjour!", speaker: "guard", options: [...] },
  //   "nodes": { ... }
  // }

  // NPCs involved
  npcs                 Json     // [{ id, name, avatar, voice_id }]

  // Audio
  has_voice            Boolean  @default(false)
  voice_urls           Json?    // Map of node_id -> audio_url

  // Gameplay
  min_level            String   // CECRL level
  category             String   // vocabulary, grammar, cultural
  tags                 String[]

  // Learning Objectives
  vocabulary_focus     String[] // Key words practiced
  grammar_focus        String[] // Grammar points

  // Stats
  times_played         Int      @default(0)
  avg_success_rate     Float?

  // Status
  active               Boolean  @default(true)
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@index([dialogue_id])
  @@index([category])
  @@map("quest_dialogues")
}

model HeroAvatar {
  id                   String   @id @default(uuid())
  housekeeper_id       String   @unique

  // Avatar Customization
  base_model           String   @default("default") // Avatar base type
  skin_tone            String   @default("medium")
  hair_style           String   @default("short")
  hair_color           String   @default("brown")
  outfit               String   @default("casual")
  accessories          String[] // ["glasses", "hat"]

  // Equipped Items (from Marketplace)
  equipped_items       Json     // { head: item_id, body: item_id, ... }

  // 3D Model Data
  model_config         Json?    // Three.js configuration
  animation_set        String   @default("standard")

  // Display Name
  hero_name            String?  // Optional custom name
  hero_title           String?  // "Le Voyageur", earned from quests

  // Metadata
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@map("hero_avatars")
}

model QuestCinematic {
  id                   String   @id @default(uuid())

  // Cinematic Details
  cinematic_id         String   @unique // "world1_intro"
  title                String
  type                 String   // "world_intro", "world_outro", "quest_intro", "quest_outro", "boss_intro", "boss_victory"

  // Content
  scenes               Json     // Array of scenes with animations
  // Example: [
  //   { type: "text", content: "Il y a 6 mois...", duration: 3000, animation: "fadeIn" },
  //   { type: "image", src: "/assets/...", animation: "slideInLeft" },
  //   { type: "dialogue", character: "narrator", text: "...", voice_url: "..." }
  // ]

  // Audio
  background_music     String?
  sound_effects        Json?    // Map of timing -> sound_url

  // Settings
  duration_seconds     Int      // Total duration
  skippable            Boolean  @default(true)
  auto_advance         Boolean  @default(true)

  // Related Entity
  related_world_id     String?
  related_quest_id     String?
  related_boss_id      String?

  // Stats
  times_viewed         Int      @default(0)
  times_skipped        Int      @default(0)

  // Status
  active               Boolean  @default(true)
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@index([cinematic_id])
  @@index([type])
  @@map("quest_cinematics")
}
// ========================================
// EXTENDED QUIZ SYSTEM - Tous Types de Questions
// ========================================

// Type de question (ENUM √©tendu)
enum QuestionType {
  TEXT_ONLY          // Question texte ‚Üí 4 options texte (existant)
  TEXT_TO_IMAGE      // Texte ‚Üí Cocher bonne image
  IMAGE_TO_TEXT      // Image ‚Üí 4 choix texte
  AUDIO_TO_IMAGE     // Audio ‚Üí Cocher bonne image
  AUDIO_TO_TEXT      // Dict√©e (audio ‚Üí √©crire)
  FILL_BLANK         // Compl√©ter phrase
  MATCHING           // Associer mots ‚Üî images
  COLOR_DESCRIPTION  // Questions descriptives (couleur, forme)
  ALPHABET           // Lettres alphabet (A1.0)
  GENDER_SELECTION   // Masculin/F√©minin
  CONJUGATION        // Conjugaison verbes
  DRAG_DROP          // Glisser-d√©poser
  FREE_WRITING       // √âcriture libre (courte)
}

// Cat√©gorie de comp√©tence
enum SkillCategory {
  LISTENING    // √âcoute (audio questions)
  SPEAKING     // Oral (pronunciation - future)
  READING      // Lecture (text questions)
  WRITING      // √âcriture (fill blank, free writing)
  GRAMMAR      // Grammaire (gender, conjugation)
  VOCABULARY   // Vocabulaire (matching, images)
  ALPHABET     // Alphabet (A1.0 pr√©-d√©butants)
}

// Question universelle (remplace LanguageQuizQuestion)
model UniversalQuizQuestion {
  id                    String   @id @default(uuid())

  // Meta
  question_type         QuestionType
  skill_category        SkillCategory
  difficulty_level      String   // A1.0, A1.1, A1.2, A2.1, ..., C2
  category              String   // bedroom, bathroom, kitchen, etc.
  subcategory           String?  // furniture, cleaning_products, etc.

  // Question Content
  question_text         String?  // Texte question (peut √™tre null si audio-only)
  question_audio_url    String?  // ElevenLabs audio URL
  question_image_url    String?  // URL image principale

  // Options (flexible JSON)
  options               Json     // Structure varie selon question_type
  correct_answer        Json     // R√©ponse correcte (peut √™tre texte, index, array)

  // Feedback
  explanation_text      String
  explanation_audio_url String?

  // Metadata
  times_shown           Int      @default(0)
  times_correct         Int      @default(0)
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  // Relations
  responses             UniversalQuizResponse[]

  @@index([question_type, difficulty_level])
  @@index([skill_category, category])
}

// Response universelle
model UniversalQuizResponse {
  id                    String   @id @default(uuid())

  question_id           String
  question              UniversalQuizQuestion @relation(fields: [question_id], references: [id])

  housekeeper_id        String
  housekeeper           Housekeeper @relation(fields: [housekeeper_id], references: [id])

  // User Answer (flexible)
  user_answer           Json     // Peut √™tre texte, index, array selon type
  is_correct            Boolean

  // Context
  session_id            String?
  time_taken_seconds    Int?
  xp_earned             Int      @default(0)

  created_at            DateTime @default(now())

  @@index([housekeeper_id, created_at])
  @@index([session_id])
}

// ============================================================================
// MODULE AGENT DE TERRAIN - Field Work Management
// ============================================================================

// Mission terrain avec propri√©t√© et t√¢ches
model Mission {
  id                       String   @id @default(uuid())
  
  // Relations
  housekeeper_id           String
  housekeeper              Housekeeper @relation(fields: [housekeeper_id], references: [id], onDelete: Cascade)
  
  // Status & Type
  status                   String   @default("pending") // pending, assigned, accepted, in_progress, paused, completed, validated, cancelled
  mission_type             String   // checkout, checkin, deep_clean, maintenance, inspection
  
  // Property Info (JSON pour flexibilit√©)
  property                 Json?    // { id, name, address, city, postalCode, coordinates: { lat, lng } }
  
  // Scheduling
  scheduled_date           DateTime
  scheduled_start_time     String?  // "14:00"
  estimated_duration_min   Int?
  
  // Access
  access_code              String?
  access_instructions      String?  @db.Text
  
  // Policies
  smoking_policy           String?  // non_smoking, smoking
  expected_occupancy       String?  // empty, checkout_in_progress, guest_may_return, owner_present, family_present
  occupancy_note           String?  @db.Text
  
  // Instructions
  instructions             String?  @db.Text
  manager_notes            String?  @db.Text
  
  // Tasks (JSON array)
  tasks                    Json?    // [{ id, label, category, productNumber, tool, isPriority, instructions, instructionsFALC, estimatedMinutes, completedAt }]
  
  // Manager
  manager_id               String?
  
  // Relations
  incidents                Incident[]
  sos_events               SOSEvent[]
  evacuation_event         EvacuationEvent?
  checkin_pointage         Pointage?        @relation("MissionCheckin")
  checkout_pointage        Pointage?        @relation("MissionCheckout")
  mission_report           MissionReport?
  security_alerts          SecurityAlert[]

  // Metadata
  created_at               DateTime @default(now())
  updated_at               DateTime @updatedAt
  
  @@index([housekeeper_id, scheduled_date])
  @@index([status])
  @@map("missions")
}

// Incident terrain avec preuves
model Incident {
  id                       String   @id @default(uuid())
  
  // Relations
  mission_id               String
  mission                  Mission  @relation(fields: [mission_id], references: [id], onDelete: Cascade)
  
  // Type & Severity
  incident_type            String   // cigarette_smell, cigarette_butts, drugs_found, sexual_objects, guest_still_present, guest_returned_early
  severity                 String   // low, medium, high, critical
  
  // Location
  gps_position             Json?    // { lat, lng, accuracy, timestamp }
  
  // Evidence (JSON array)
  evidence                 Json     @default("[]") // [{ id, type, uri, timestamp, status, gpsPosition, notes }]
  
  // Manager Call
  manager_called           Boolean  @default(false)
  manager_called_at        DateTime?
  
  // Notes & Resolution
  notes                    String?  @db.Text
  resolved_at              DateTime?
  resolution               String?  @db.Text
  
  // Metadata
  timestamp                DateTime @default(now())
  
  @@index([mission_id])
  @@index([severity])
  @@map("incidents")
}

// √âv√©nement SOS d'urgence
model SOSEvent {
  id                       String   @id @default(uuid())
  
  // Relations
  mission_id               String
  mission                  Mission  @relation(fields: [mission_id], references: [id], onDelete: Cascade)
  
  // Category & Action
  sos_category             String   // access, products, problem, danger
  sos_action               String?  // call_employer, call_emergency, leave_premises
  
  // Location
  gps_position             Json?    // { lat, lng, accuracy, timestamp }
  
  // Resolution
  resolved                 Boolean  @default(false)
  resolved_at              DateTime?
  
  // Metadata
  timestamp                DateTime @default(now())
  
  @@index([mission_id])
  @@map("sos_events")
}

// √âv√©nement d'√©vacuation
model EvacuationEvent {
  id                       String   @id @default(uuid())
  
  // Relations
  mission_id               String   @unique
  mission                  Mission  @relation(fields: [mission_id], references: [id], onDelete: Cascade)
  
  // Motivation
  motivation_id            String   // person_threatening, person_aggressive, unsafe_environment, etc.
  motivation_label         String
  custom_reason            String?  @db.Text
  
  // Location
  gps_position             Json?    // { lat, lng, accuracy, timestamp }
  
  // Employer Notification
  employer_notified        Boolean  @default(false)
  employer_notified_at     DateTime?
  
  // Metadata
  timestamp                DateTime @default(now())
  
  @@index([mission_id])
  @@map("evacuation_events")
}

// Pointage (Check-in/Check-out)
model Pointage {
  id                       String   @id @default(uuid())
  
  // Relations
  mission_checkin_id       String?  @unique
  mission_checkin          Mission? @relation("MissionCheckin", fields: [mission_checkin_id], references: [id], onDelete: Cascade)
  
  mission_checkout_id      String?  @unique
  mission_checkout         Mission? @relation("MissionCheckout", fields: [mission_checkout_id], references: [id], onDelete: Cascade)
  
  // Method
  pointage_method          String   // qr, gps, manual, nfc
  
  // GPS Data
  gps_position             Json?    // { lat, lng, accuracy, timestamp }
  
  // Verification
  verified                 Boolean  @default(false)
  
  // Metadata
  timestamp                DateTime @default(now())
  
  @@index([mission_checkin_id])
  @@index([mission_checkout_id])
  @@map("pointages")
}

// Rapport de mission
model MissionReport {
  id                       String   @id @default(uuid())
  
  // Relations
  mission_id               String   @unique
  mission                  Mission  @relation(fields: [mission_id], references: [id], onDelete: Cascade)
  
  // Report Type
  report_type              String   // internal, guest_ready
  
  // Validity
  validity                 String   // valid, valid_with_incidents, conditional, invalid
  
  // Task Summary
  tasks_completed          Int      @default(0)
  tasks_total              Int      @default(0)
  
  // Notes
  notes                    String?  @db.Text
  
  // Photos (JSON array)
  photos                   Json     @default("[]") // Evidence photos approved for guest
  pending_evidence         Json     @default("[]") // Evidence awaiting manager validation
  
  // Signature
  signature                String?  // Base64 or URL
  
  // Metadata
  generated_at             DateTime @default(now())
  
  @@index([mission_id])
  @@index([validity])
  @@map("mission_reports")
}

// Alertes de s√©curit√©
model SecurityAlert {
  id                       String   @id @default(uuid())

  // Relations
  housekeeper_id           String
  housekeeper              Housekeeper @relation(fields: [housekeeper_id], references: [id], onDelete: Cascade)
  mission_id               String?
  mission                  Mission?     @relation(fields: [mission_id], references: [id], onDelete: Cascade)

  // Type d'alerte
  alert_type               String   // unauthorized_device, gps_too_far, gps_imprecise, wrong_property, suspicious_timing
  severity                 String   // low, medium, high, critical

  // D√©tails
  title                    String
  message                  String   @db.Text
  details                  Json?    // Donn√©es contextuelles (distance, accuracy, device_id, etc.)

  // Localisation
  attempted_location       Json?    // { lat, lng, accuracy }
  expected_location        Json?    // { lat, lng }

  // Status
  status                   String   @default("unread") // unread, read, acknowledged, resolved, dismissed
  acknowledged_by          String?  // Manager ID
  acknowledged_at          DateTime?
  resolution_notes         String?  @db.Text

  // Metadata
  created_at               DateTime @default(now())
  updated_at               DateTime @updatedAt

  @@index([housekeeper_id])
  @@index([mission_id])
  @@index([alert_type])
  @@index([severity])
  @@index([status])
  @@index([created_at])
  @@map("security_alerts")
}


// ============================================
// üìä SMS LOGS - Historique des envois
// ============================================
model SmsLog {
  id                 String    @id @default(cuid())
  messageSid         String?   @unique
  destinataire       String
  messageContenu     String    @db.Text
  messageResume      String?
  type               String
  statut             String
  raison             String?
  codeErreur         Int?
  dureeMs            Int?
  idUtilisateur      String?
  tentatives         Int       @default(1)
  dateCreation       DateTime  @default(now())
  dateEnvoi          DateTime?
  dateLivraison      DateTime?
  dateExpiration     DateTime?

  // üÜï Champs FATE
  fateProfile        String?   // F, A, T, E, default ou null
  templateName       String?   // Nom du template utilis√©
  fateConfidence     Float?    // Score de confiance 0.0-1.0

  @@index([destinataire])
  @@index([statut])
  @@index([dateCreation])
  @@index([type])
  @@index([fateProfile])      // üÜï Index pour analytics FATE
}

// ============================================
// üé≠ FATE_PROFILE - Profils comportementaux d√©tect√©s
// ============================================
model FATE_Profile {
  id                 String    @id @default(uuid())
  bookingId          String?   // Lien vers r√©servation
  guestPhone         String    // Num√©ro voyageur
  profile            String    // F, A, T, E, default
  confidence         Float     // Score confiance 0.0-1.0
  reasons            String[]  // Raisons de d√©tection

  // Donn√©es booking utilis√©es pour d√©tection
  nbGuests           Int?
  duration           Int?      // Dur√©e s√©jour en jours
  propertyType       String?
  hasChildren        Boolean   @default(false)

  // Enrichissement par messages (Phase 2)
  keywordsFound      String[]  // Mots-cl√©s d√©tect√©s dans messages

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([profile])
  @@index([guestPhone])
  @@index([bookingId])
  @@map("fate_profiles")
}

// ============================================
// üö´ BLOCKLIST - Num√©ros opt-out
// ============================================
model BlocklistSms {
  id                 String    @id @default(cuid())
  numero             String    @unique
  raison             String
  dateAjout          DateTime  @default(now())
  dateModification   DateTime  @updatedAt
  motif              String?
  
  @@index([numero])
}

// ============================================
// üìã CONSENTEMENT SMS - RGPD
// ============================================
model ConsentementSms {
  id                 String    @id @default(cuid())
  idUtilisateur      String
  numero             String
  consentement       Boolean   @default(false)
  typeConsent        String[]
  dateConsent        DateTime?
  dateRevocation     DateTime?
  ipAdresse          String?
  userAgent          String?
  dateCreation       DateTime  @default(now())
  dateModification   DateTime  @updatedAt
  
  @@unique([idUtilisateur, numero])
  @@index([numero])
  @@index([dateCreation])
}

// ============================================================================
// DATA ENGINE v3.0 ‚Äî Valorisation des donn√©es
// ============================================================================

// Habilitations internes Data Engine
model InternalAccess {
  id          String    @id @default(uuid())
  user_id     String
  granted_by  String
  role        String    // ADMIN, INTERNAL_DATA, CTO, CEO
  permissions String[]  @default([])
  is_active   Boolean   @default(true)
  granted_at  DateTime  @default(now())
  revoked_at  DateTime?
  reason      String?

  @@unique([user_id])
  @@index([user_id, is_active])
  @@map("internal_access")
}

model DataAsset {
  id                  String   @id @default(uuid())
  name                String
  slug                String   @unique
  description         String?
  category            String   // operational, behavioral, market, predictive, financial, geographic
  subcategory         String?
  sensitivity_level   Int      @default(1)
  contains_pii        Boolean  @default(false)
  pii_types           String[] @default([])
  legal_basis         String   @default("legitimate_interest")
  source_systems      String[] @default([])
  volume_records      Int      @default(0)
  freshness_hours     Float    @default(24)
  quality_score       Int      @default(0)
  uniqueness_score    Int      @default(0)
  demand_score        Int      @default(0)
  freshness_score     Int      @default(0)
  monetization_score  Int      @default(0)
  pipeline_stage      String   @default("raw")
  anonymization_level String   @default("raw")
  base_price_per_1000 Float    @default(0)
  estimated_revenue_min Float  @default(0)
  estimated_revenue_max Float  @default(0)
  eligible_models     String[] @default([])
  tags                String[] @default([])
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  classifications     ClassificationHistory[]
  compliance_checks   ComplianceCheck[]
  data_products       DataProduct[]

  @@index([category])
  @@index([pipeline_stage])
  @@index([monetization_score])
  @@map("data_assets")
}

model ClassificationHistory {
  id         String   @id @default(uuid())
  asset_id   String
  source     String   @default("claude_api")
  result     Json
  confidence Float
  created_at DateTime @default(now())

  asset DataAsset @relation(fields: [asset_id], references: [id])

  @@index([asset_id])
  @@map("classification_history")
}

model ComplianceCheck {
  id          String    @id @default(uuid())
  asset_id    String
  regulation  String
  check_name  String
  description String?
  article     String?
  status      String    @default("pending_review")
  priority    String    @default("medium")
  resolved_at DateTime?
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  asset DataAsset @relation(fields: [asset_id], references: [id])

  @@index([asset_id])
  @@index([regulation])
  @@map("compliance_checks")
}

model DataProduct {
  id            String   @id @default(uuid())
  asset_id      String
  name          String
  description   String?
  status        String   @default("draft")
  pricing_tiers Json?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  asset DataAsset @relation(fields: [asset_id], references: [id])

  @@map("data_products")
}

model Partner {
  id                 String   @id @default(uuid())
  name               String
  company            String?
  email              String   @unique
  type               String   @default("analytics")
  tier               String   @default("free")
  contract_status    String   @default("prospect")
  stripe_customer_id String?
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  api_keys ApiKey[]

  @@map("partners")
}

model ApiKey {
  id                    String    @id @default(uuid())
  partner_id            String
  key_hash              String    @unique
  prefix                String
  tier                  String
  rate_limit_per_minute Int       @default(10)
  is_active             Boolean   @default(true)
  expires_at            DateTime?
  last_used_at          DateTime?
  created_at            DateTime  @default(now())

  partner Partner @relation(fields: [partner_id], references: [id])

  @@index([prefix])
  @@map("api_keys")
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String
  entity_type String
  entity_id   String
  actor_id    String?
  actor_type  String?
  details     Json?
  created_at  DateTime @default(now())

  @@index([entity_type, entity_id])
  @@index([created_at])
  @@map("audit_logs")
}

// ============================================================================
// GUEST PORTAL V5 ‚Äî Auth, Reservations, Services, Ratings
// ============================================================================

enum AuthProvider {
  EMAIL_MAGIC_LINK
  GOOGLE
  APPLE
  RESERVATION_CODE
}

model MagicLink {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([email])
}

// ‚îÄ‚îÄ‚îÄ PROPERTIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

model Owner {
  id         String     @id @default(cuid())
  email      String     @unique
  firstName  String
  lastName   String
  company    String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  properties Property[]
}

model Property {
  id           String   @id @default(cuid())
  name         String
  address      String
  city         String?
  zipCode      String?
  country      String   @default("FR")
  latitude     Float
  longitude    Float
  checkInTime  String   @default("15:00")
  checkOutTime String   @default("11:00")
  wifiName     String?
  wifiPassword String?
  houseRules   Json?
  cameras      Json?    // d√©claration l√©gale cam√©ras
  pets         Json?    // d√©claration animaux
  alarms       Json?    // d√©claration alarmes
  imageUrls    String[] // photos du logement

  ownerId String
  owner   Owner  @relation(fields: [ownerId], references: [id])

  reservations         Reservation[]
  services             Service[]
  transportPoints      TransportPoint[]
  checklistItems       ChecklistItem[]
  recommendations      HostRecommendation[]
  knowledgeBaseEntries KnowledgeBaseEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
}

// ‚îÄ‚îÄ‚îÄ RESERVATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

model Reservation {
  id           String            @id @default(cuid())
  code         String            @unique // code acc√®s guest (ex: VEC-A7K9)
  guestId      String
  guest        Guest             @relation(fields: [guestId], references: [id])
  propertyId   String
  property     Property          @relation(fields: [propertyId], references: [id])
  checkIn      DateTime
  checkOut     DateTime
  guestCount   Int               @default(1)
  status       ReservationStatus @default(CONFIRMED)
  source       String?           // Airbnb, Booking, direct
  checkinDone  Boolean           @default(false)
  checkoutDone Boolean           @default(false)

  guestMessages         GuestMessage[]
  ratings               Rating[]
  orders                Order[]
  checklistCompletions  ChecklistCompletion[]
  travelJournalEntries  TravelJournalEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([guestId])
  @@index([propertyId])
  @@index([code])
}

enum ReservationStatus {
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
}

// ‚îÄ‚îÄ‚îÄ CHECKOUT CHECKLIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

model ChecklistItem {
  id         String   @id @default(cuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])
  label      String   // FR par d√©faut
  labelEn    String?
  labelEs    String?
  order      Int
  required   Boolean  @default(true)

  completions ChecklistCompletion[]

  @@index([propertyId])
}

model ChecklistCompletion {
  id              String   @id @default(cuid())
  reservationId   String
  reservation     Reservation   @relation(fields: [reservationId], references: [id])
  checklistItemId String
  checklistItem   ChecklistItem @relation(fields: [checklistItemId], references: [id])
  completed       Boolean       @default(false)
  completedAt     DateTime?
  photoUrl        String?

  @@unique([reservationId, checklistItemId])
}

// ‚îÄ‚îÄ‚îÄ GUEST MESSAGING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

model GuestMessage {
  id                String     @id @default(cuid())
  reservationId     String?
  reservation       Reservation? @relation(fields: [reservationId], references: [id])
  senderId          String?
  guest             Guest?     @relation(fields: [senderId], references: [id])
  conversationId    String?
  senderType        SenderType
  content           String
  translatedContent String?
  readAt            DateTime?
  createdAt         DateTime   @default(now())

  @@index([reservationId, createdAt])
  @@index([conversationId, createdAt])
  @@index([senderId])
}

enum SenderType {
  GUEST
  HOST
  SYSTEM
  AI
}

// ‚îÄ‚îÄ‚îÄ SERVICES & ORDERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

model Service {
  id          String          @id @default(cuid())
  propertyId  String
  property    Property        @relation(fields: [propertyId], references: [id])
  name        String
  nameEn      String?
  description String?
  category    ServiceCategory
  price       Int             // centimes
  currency    String          @default("EUR")
  imageUrl    String?
  available   Boolean         @default(true)
  stock       Int?            // null = illimit√©

  orderItems OrderItem[]

  @@index([propertyId, category])
}

enum ServiceCategory {
  MINIBAR
  BREAKFAST
  EXPERIENCE
  TRANSPORT
  CLEANING
  OTHER
}

model Order {
  id              String      @id @default(cuid())
  reservationId   String
  reservation     Reservation @relation(fields: [reservationId], references: [id])
  guestId         String
  guest           Guest       @relation(fields: [guestId], references: [id])
  totalAmount     Int         // centimes
  currency        String      @default("EUR")
  stripePaymentId String?
  status          OrderStatus @default(PENDING)

  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reservationId])
  @@index([guestId])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])
  quantity  Int
  unitPrice Int     // centimes, snapshot au moment de la commande
}

enum OrderStatus {
  PENDING
  PAID
  CONFIRMED
  DELIVERED
  CANCELLED
  REFUNDED
}

// ‚îÄ‚îÄ‚îÄ RATINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

model Rating {
  id            String      @id @default(cuid())
  reservationId String      @unique
  reservation   Reservation @relation(fields: [reservationId], references: [id])
  guestId       String
  guest         Guest       @relation(fields: [guestId], references: [id])
  overall       Int         // 1-5
  cleanliness   Int?        // 1-5
  communication Int?        // 1-5
  location      Int?        // 1-5
  comfort       Int?        // 1-5
  comment       String?
  createdAt     DateTime    @default(now())

  @@index([guestId])
}

// ‚îÄ‚îÄ‚îÄ GPS & TRANSPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

model TransportPoint {
  id             String        @id @default(cuid())
  propertyId     String
  property       Property      @relation(fields: [propertyId], references: [id])
  name           String
  type           TransportType
  latitude       Float
  longitude      Float
  distanceMeters Int
  walkMinutes    Int?
  transitMinutes Int?
  driveMinutes   Int?
  notes          String?
  notesEn        String?

  @@index([propertyId, type])
}

enum TransportType {
  METRO
  BUS
  TRAIN
  TAXI_STAND
  AIRPORT
  SUPERMARKET
  PHARMACY
  RESTAURANT
  ATTRACTION
  PARKING
}

// ‚îÄ‚îÄ‚îÄ HOST RECOMMENDATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

model HostRecommendation {
  id          String                    @id @default(cuid())
  propertyId  String
  property    Property                  @relation(fields: [propertyId], references: [id])
  category    RecommendationCategory
  name        String
  address     String?
  description String?                   // Host personal comment
  rating      Float?                    // Host rating (1-5)
  latitude    Float?
  longitude   Float?
  mapsUrl     String?                   // Google Maps link
  imageUrl    String?
  phone       String?
  website     String?
  sortOrder   Int                       @default(0)
  active      Boolean                   @default(true)
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt

  @@index([propertyId, category])
  @@index([propertyId, active])
}

enum RecommendationCategory {
  RESTAURANT
  CAFE
  BAR
  BAKERY
  SHOP
  SUPERMARKET
  PHARMACY
  ATTRACTION
  MUSEUM
  PARK
  SPORT
  NIGHTLIFE
  OTHER
}

// ‚îÄ‚îÄ‚îÄ TRAVEL JOURNAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

model TravelJournalEntry {
  id            String       @id @default(cuid())
  guestId       String
  guest         Guest        @relation(fields: [guestId], references: [id])
  reservationId String?
  reservation   Reservation? @relation(fields: [reservationId], references: [id])
  type          String       @default("note") // note, memory, tip, checklist, highlight
  title         String       @default("")
  content       String
  emoji         String       @default("üìù")
  mood          String?      // happy, excited, relaxed, adventurous, neutral, sad
  photos        String[]
  location      Json?        // { lat, lng, label? }
  tags          String[]
  pinned        Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([guestId, createdAt])
  @@index([guestId, reservationId])
}

// ============================================================================
// EMPLOYEE DASHBOARD & CRM
// ============================================================================

model Employee {
  id              String    @id @default(uuid())
  matricule       String    @unique        // "VEC-001", login identifier
  first_name      String
  last_name       String
  email           String    @unique
  password_hash       String
  role                String    @default("employee")  // "ceo", "manager", "employee"
  active              Boolean   @default(true)
  avatar_url          String?              // Profile photo URL
  temp_password       Boolean   @default(false) // Must change password on first login
  work_schedule_start String    @default("08:00") // Authorized connection start
  work_schedule_end   String    @default("19:00") // Authorized connection end
  nda_accepted_at     DateTime?           // Non-disclosure agreement acceptance date
  last_login          DateTime?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  call_sessions       CallSession[]
  prospects           Prospect[]
  notes               EmployeeNote[]
  tasks               EmployeeTask[]
  screenshot_alerts   EmployeeScreenshotAlert[]
  sessions            EmployeeSession[]
  otps                EmployeeOtp[]
  pointages           EmployeePointage[]

  @@map("employees")
}

model Prospect {
  id                String    @id @default(uuid())
  employee_id       String
  employee          Employee  @relation(fields: [employee_id], references: [id])

  company_name      String
  contact_name      String?
  contact_role      String?             // "PDG", "DRH", "journalist", etc.
  phone             String?
  email             String?
  status            String    @default("new")  // new, contacted, meeting, proposal, won, lost
  fate_profile      String?             // F, A, T, E
  interlocutor_type String?             // journalist, pdg, investor, prospect

  notes             String?   @db.Text
  last_contact      DateTime?
  next_action       String?
  next_action_date  DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  call_sessions     ProspectCall[]

  @@index([employee_id])
  @@index([status])
  @@map("prospects")
}

model ProspectCall {
  id              String      @id @default(uuid())
  prospect_id     String
  prospect        Prospect    @relation(fields: [prospect_id], references: [id], onDelete: Cascade)
  session_id      String
  session         CallSession @relation(fields: [session_id], references: [id])

  outcome         String?             // "interested", "follow_up", "rejected", "no_answer"
  summary         String?   @db.Text  // AI-generated call summary
  created_at      DateTime  @default(now())

  @@index([prospect_id])
  @@index([session_id])
  @@map("prospect_calls")
}

model EmployeeNote {
  id              String    @id @default(uuid())
  employee_id     String
  employee        Employee  @relation(fields: [employee_id], references: [id])

  title           String
  content         String    @db.Text
  category        String    @default("general")  // general, call, prospect, idea
  pinned          Boolean   @default(false)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  @@index([employee_id])
  @@map("employee_notes")
}

model EmployeeTask {
  id              String    @id @default(uuid())
  employee_id     String
  employee        Employee  @relation(fields: [employee_id], references: [id])

  title           String
  description     String?   @db.Text
  status          String    @default("todo")  // todo, in_progress, done
  priority        String    @default("medium") // low, medium, high
  start_date      DateTime?
  due_date        DateTime?
  completed_at    DateTime?
  created_by      String              // employee_id of creator (CEO can assign)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  @@index([employee_id])
  @@index([status])
  @@map("employee_tasks")
}

// ============================================================================
// EMPLOYEE SESSIONS (Connection Logs)
// ============================================================================

model EmployeeSession {
  id               String    @id @default(uuid())
  employee_id      String
  employee         Employee  @relation(fields: [employee_id], references: [id])
  login_at         DateTime  @default(now())
  logout_at        DateTime?
  ip_address       String?
  user_agent       String?
  is_active        Boolean   @default(true)
  outside_schedule Boolean   @default(false)
  created_at       DateTime  @default(now())

  @@index([employee_id])
  @@index([login_at])
  @@index([is_active])
  @@map("employee_sessions")
}

// ============================================================================
// EMPLOYEE OTP (Email-based 2FA)
// ============================================================================

model EmployeeOtp {
  id            String    @id @default(uuid())
  employee_id   String
  employee      Employee  @relation(fields: [employee_id], references: [id])
  code          String
  purpose       String    // "login_2fa", "password_reset", "invitation"
  expires_at    DateTime
  used_at       DateTime?
  attempts      Int       @default(0)
  created_at    DateTime  @default(now())

  @@index([employee_id, purpose])
  @@index([code])
  @@map("employee_otps")
}

// ============================================================================
// EMPLOYEE SCREENSHOT ALERTS (Security / Anti-leak)
// ============================================================================

model EmployeeScreenshotAlert {
  id              String    @id @default(uuid())
  employee_id     String
  employee        Employee  @relation(fields: [employee_id], references: [id])

  screenshot      String    @db.Text  // Base64 image data
  page_url        String              // Route where screenshot was taken
  page_title      String              // Readable page name
  context_summary String    @db.Text  // AI or auto-generated summary of what was on screen
  detection_method String             // "keydown", "visibility_change", "devtools"
  severity        String    @default("high") // low, medium, high, critical

  acknowledged    Boolean   @default(false)
  acknowledged_at DateTime?
  acknowledged_by String?             // CEO employee_id who acknowledged

  created_at      DateTime  @default(now())

  @@index([employee_id])
  @@index([created_at])
  @@index([acknowledged])
  @@map("employee_screenshot_alerts")
}

// ============================================================================
// EMPLOYEE POINTAGE (Geolocation Clock-in/Clock-out)
// ============================================================================

model EmployeePointage {
  id              String    @id @default(uuid())
  employee_id     String
  employee        Employee  @relation(fields: [employee_id], references: [id])

  type            String                // "clock_in" or "clock_out"
  lat             Float?
  lng             Float?
  accuracy        Float?                // GPS accuracy in meters
  address         String?               // Reverse-geocoded address (optional)
  method          String    @default("gps") // gps, manual, qr
  verified        Boolean   @default(false)
  notes           String?

  created_at      DateTime  @default(now())

  @@index([employee_id])
  @@index([created_at])
  @@map("employee_pointages")
}

// ============================================================================
// AI CALL ASSISTANT ("Souffleur Intelligent")
// ============================================================================

model CallSession {
  id              String   @id @default(uuid())
  user_id         String
  employee_id     String?
  employee        Employee? @relation(fields: [employee_id], references: [id])
  title           String?
  platform        String?  // "meet", "zoom", "teams"
  status          String   @default("active") // active, ended
  started_at      DateTime @default(now())
  ended_at        DateTime?

  transcripts     CallTranscript[]
  suggestions     CallSuggestion[]
  prospect_calls  ProspectCall[]

  @@index([user_id])
  @@index([employee_id])
  @@map("call_sessions")
}

model CallTranscript {
  id              String   @id @default(uuid())
  session_id      String
  session         CallSession @relation(fields: [session_id], references: [id], onDelete: Cascade)

  speaker         String   @default("unknown") // "me", "guest", "unknown"
  text            String   @db.Text
  confidence      Float?
  timestamp_ms    Int      // offset from session start

  created_at      DateTime @default(now())

  @@index([session_id])
  @@map("call_transcripts")
}

model CallSuggestion {
  id              String   @id @default(uuid())
  session_id      String
  session         CallSession @relation(fields: [session_id], references: [id], onDelete: Cascade)

  trigger_text    String   @db.Text  // the question that triggered it
  suggestion      String   @db.Text  // AI-generated answer
  sources         Json?              // matched KB entries
  was_used        Boolean  @default(false)

  created_at      DateTime @default(now())

  @@index([session_id])
  @@map("call_suggestions")
}

// ============================================================================
// SUBSCRIPTIONS & BILLING
// ============================================================================

enum SubscriptionPlan {
  free
  starter
  pro
  enterprise
}

enum SubscriptionStatus {
  trialing
  active
  past_due
  cancelled
  expired
}

enum BillingInterval {
  monthly
  yearly
}

model Subscription {
  id                     String             @id @default(uuid())
  organization_id        String
  organization           Organization       @relation(fields: [organization_id], references: [id])

  // Plan
  plan                   SubscriptionPlan   @default(free)
  status                 SubscriptionStatus @default(trialing)
  billing_interval       BillingInterval    @default(monthly)

  // Trial
  trial_start            DateTime?
  trial_end              DateTime?

  // Stripe
  stripe_customer_id     String?            @unique
  stripe_subscription_id String?            @unique
  stripe_price_id        String?

  // Dates
  current_period_start   DateTime?
  current_period_end     DateTime?
  cancelled_at           DateTime?

  // Metadata
  created_at             DateTime           @default(now())
  updated_at             DateTime           @updatedAt

  // Invoices
  invoices               Invoice[]

  @@map("subscriptions")
}

model Invoice {
  id                     String       @id @default(uuid())
  subscription_id        String
  subscription           Subscription @relation(fields: [subscription_id], references: [id])

  stripe_invoice_id      String?      @unique
  amount_cents           Int
  currency               String       @default("eur")
  status                 String       @default("draft") // draft, open, paid, void, uncollectible
  invoice_url            String?
  invoice_pdf            String?

  period_start           DateTime?
  period_end             DateTime?
  paid_at                DateTime?

  created_at             DateTime     @default(now())

  @@map("invoices")
}
